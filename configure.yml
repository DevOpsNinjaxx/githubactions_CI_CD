---
- name: Configure Server
  hosts: web
  become: true
  remote_user: ubuntu

  tasks:
    - name: Install necessary packages
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present

    - name: Install dependencies
      shell: |
        cd /home/ubuntu/app
        npm install

    - name: "Install forever (to run Node.js app)."
      npm: name=forever global=yes state=present

    - name: "Check list of Node.js apps running."
      command: forever list
      register: forever_list
      changed_when: false


    - name: "Start example Node.js app."
      command: forever start /home/ubuntu/app/index.js
      when: "forever_list.stdout.find('/home/ubuntu/app/index.js') == -1"  

    #- name: Start application
    #  shell: |
    #    cd ~/app
    #    npm start